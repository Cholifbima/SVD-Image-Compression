<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="{{ url_for('static', filename='css/output.css') }}" rel="stylesheet">
    <title>Hasil Kompresi</title>
</head>

<body class="flex flex-col min-h-screen w-full">
    <header class="bg-biru-muda">
        <div class="grid grid-cols-[1fr_2fr_1fr] items-center py-7">
            <div class="flex justify-start pl-24">
                <img src="{{ url_for('static', filename='img/logo-uns.png') }}" alt="logo-uns" class="h-14 w-auto" />
            </div>
            <div class="text-center">
                <h1 class="flex justify-center items-center text-5xl text-biru-tua-banget font-bold">Image Compression</h1>
            </div>
            <div></div>
        </div>
        <div class="h-1 bg-biru-tua-banget mx-12"></div>
    </header>

    <main class="flex-1 bg-biru-muda py-12 flex flex-col items-center gap-8 px-12">
        <h2 class="text-3xl font-bold text-biru-tua-banget">Hasil Kompresi</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="text-center">
                <h3 class="text-xl font-semibold mb-2">Gambar Asli</h3>
                <div class="border-3 border-biru rounded-3xl w-full flex-1 flex flex-col gap-4 justify-center items-center relative  overflow-hidden object-contain">
                    <img src="{{ url_for('preview', fname=before_fname) }}" alt="sebelum" class="shadow-lg">
                </div>
            </div>
            <div class="text-center">
                <h3 class="text-xl font-semibold mb-2">Gambar Terkompresi</h3>
                <div class="border-3 border-biru rounded-3xl w-full flex-1 flex flex-col gap-4 justify-center items-center relative  overflow-hidden object-contain">
                    <img id="compressedImg" src="{{ url_for('preview', fname=after_fname) }}" alt="sesudah" class="shadow-lg">
                </div>
            </div>
        </div>
        
        <div class="w-4/5 md:w-1/2 mt-6 flex flex-col items-center gap-2">
            <label for="kSlider" class="text-lg font-semibold">Sesuaikan nilai k: <span id="kVal">{{ k }}</span></label>
            <input type="range" id="kSlider" min="1" max="400" value="{{ k }}" class="w-full h-2 rounded-lg accent-blue-600">
        </div>

        <div id="stats" class="bg-white border-4 border-biru rounded-4xl p-6 w-3/4 md:w-1/2 text-base leading-relaxed mt-4">
            <h4 class="font-bold text-lg mb-3">SVD Mathematical Metrics</h4>
            <p><strong>Image size:</strong> {{ dimension }}</p>
            <p><strong>#pixels:</strong> {{ total_pixels }}</p>
            <p><strong>Uncompressed matrix size:</strong> {{ uncompressed_matrix_size }} (proportional to pixels)</p>
            <p><strong>Compressed matrix size:</strong> {{ compressed_matrix_size }} ({{ height }}Ã—{{ k }} + {{ k }} + {{ k }}Ã—{{ width }}) Ã— 3</p>
            <p><strong>SVD compression ratio:</strong> {{ svd_compression_ratio }}</p>
            
            <hr class="my-4">
            <h4 class="font-bold text-lg mb-3">File Size Metrics (Secondary)</h4>
            <p><strong>Ukuran sebelum:</strong> {{ before_size_kb }} KB</p>
            <p><strong>Ukuran sesudah:</strong> {{ after_size_kb }} KB</p>
            <p><strong>Rasio kompresi file:</strong> {{ ratio }}</p>
            <p><strong>Info preserved:</strong> <span id="infoPreserved">{{ info_preserved }}%</span></p>
            
            <hr class="my-4">
            <div class="bg-blue-50 p-3 rounded text-sm">
                <p class="font-semibold text-blue-800">ðŸ’¡ Catatan Penting:</p>
                <p class="text-blue-700">SVD compression ratio menunjukkan kompresi matematis matriks. File size disesuaikan dengan info yang tersisa (k rendah = kualitas JPEG lebih rendah karena detail sudah hilang dari SVD).</p>
            </div>
            
            <hr class="my-4">
            <p><strong>Nilai k:</strong> {{ k }}</p>
            <p><strong>Runtime:</strong> {{ runtime }} detik</p>
            <p><strong>Level:</strong> {{ preset }}</p>
        </div>

        <a id="downloadBtn" href="{{ url_for('download', fname=after_fname) }}" class="bg-biru-tua text-white text-xl rounded-full px-10 py-3 mt-4">Download Hasil</a>
        
    </main>

    <footer>
        <div class="w-full bg-biru-tua text-white text-center py-4">&copy; 2025, Cholif Bima A - Lutfiyah Istiana - Shafa Rifkika NF</div>
    </footer>

    <script>
        const debounceDelay=400;
        let timer=null;
        const slider=document.getElementById('kSlider');
        const kLabel=document.getElementById('kVal');
        const img=document.getElementById('compressedImg');
        const statsDiv=document.getElementById('stats');
        const dlBtn=document.getElementById('downloadBtn');
        const origName='{{ before_fname }}';
        
        slider.oninput=()=>{
            kLabel.textContent=slider.value;
            if(timer) clearTimeout(timer);
            timer=setTimeout(doRecompress, debounceDelay);
        };
        
        function doRecompress(){
            const fd=new FormData();
            fd.append('fname', origName);
            fd.append('k', slider.value);
            fetch('/recompress', {method:'POST', body:fd})
              .then(r=>r.json()).then(d=>{
                if(d.error){console.error(d.error);return;}
                img.src=d.url+'?'+Date.now();
                statsDiv.innerHTML=`<h4 class="font-bold text-lg mb-3">SVD Mathematical Metrics</h4>
                    <p><strong>Image size:</strong> ${d.dimension}</p>
                    <p><strong>#pixels:</strong> ${d.total_pixels}</p>
                    <p><strong>Uncompressed matrix size:</strong> ${d.uncompressed_matrix_size} (proportional to pixels)</p>
                    <p><strong>Compressed matrix size:</strong> ${d.compressed_matrix_size} (${d.height}Ã—${d.k} + ${d.k} + ${d.k}Ã—${d.width}) Ã— 3</p>
                    <p><strong>SVD compression ratio:</strong> ${d.svd_compression_ratio}</p>
                    
                    <hr class="my-4">
                    <h4 class="font-bold text-lg mb-3">File Size Metrics (Secondary)</h4>
                    <p><strong>Ukuran sebelum:</strong> ${d.before_kb} KB</p>
                    <p><strong>Ukuran sesudah:</strong> ${d.after_kb} KB</p>
                    <p><strong>Rasio kompresi file:</strong> ${d.ratio}%</p>
                    <p><strong>Info preserved:</strong> <span id="infoPreserved">${d.info_preserved}%</span></p>
                    
                    <hr class="my-4">
                    <div class="bg-blue-50 p-3 rounded text-sm">
                        <p class="font-semibold text-blue-800">ðŸ’¡ Catatan Penting:</p>
                        <p class="text-blue-700">SVD compression ratio menunjukkan kompresi matematis matriks. File size disesuaikan dengan info yang tersisa (k rendah = kualitas JPEG lebih rendah karena detail sudah hilang dari SVD).</p>
                    </div>
                    
                    <hr class="my-4">
                    <p><strong>Nilai k:</strong> ${d.k}</p>
                    <p><strong>Runtime:</strong> ${d.runtime} detik</p>`;
                dlBtn.href=d.url.replace('/preview/','/download/');
            });
        }
    </script>
</body>
</html>